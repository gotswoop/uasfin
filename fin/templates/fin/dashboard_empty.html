{% extends 'fin/base.html' %}
{% block content %}
{% load humanize %}

<div id="intro" class="border border border-success p-4	">
	<h4>Welcome to the UASFin Study!</h4>
	<hr/>
	<p>To participate in this study, you will link your financial institution accounts to our secure website. This is done through Plaid, a company trusted by millions of consumers to connect their bank and other financial accounts with software applications that can help them manage their spending and save for retirement.</p>

	<p>The linking process is simple: 

	<ol>
	<li>Click on "Link Account using Plaid"</li>
	<li>Find your financial institution in the list or search for it using the search box</li>
	<li>Click on your financial institution logo</li>
	<li>Enter your financial institution credentials and click "Submit"</li>
	</ol>

	<p>Repeat steps 1-4 for each of your financial institutions. Once your financial institutions are linked, you will see all your accounts on our secure website and will be able to easily keep track of your financial transactions and account balances in one place.</p>

	<p>For each financial institution you link, you will earn a reward of $10 right now, plus a reward of $5 every month (as long as your financial institution remains linked). The green box on the screen tells you how much rewards you have earned as you link institutions.</p>

	<p>Remember, <strong>we will NOT have access to your credentials or any other identifying information.</strong></p>

	<p>Your financial information will be kept secure and protected. Plaid will never share your login IDs, passwords, or any other personal information with UAS researchers or anyone else.</p>

	<button class="link-btn btn btn-lg btn-primary">Link Account using Plaid</button>
	<br/>
</div>

<div id="success" class="panel-collapse collapse in">
	<div class="card mb-3">
		<div class="card-body">
	  		<h4 id="success_summary" class="card-title text-success"></h4>
	  		<p class="card-text pt-2">Would you like to link another institution? <br/><br/>For each financial institution you link, you will earn a reward of $10 right now, plus a reward of $5 every month</p>
	  	</div>
	</div>
	<p>
		<button class="link-btn btn btn-lg btn-primary">Link Another Account</button>
		<button class="link-btn-no ml-3 btn btn-lg btn-outline-info" value="1">No</button>
	</p>
</div>

<div id="failure" class="panel-collapse collapse in">
	<div class="card mb-3">
		<div class="card-body">
	  		<h4 id="failure_summary" class="card-title text-danger"></h4>
	  		<p class="card-text pt-2">Would you like to link a different institution? <br/><br/>For each financial institution you link, you will earn a reward of $10 right now, plus a reward of $5 every month</p>
	  	</div>
	</div>
	<p>
		<button class="link-btn btn btn-lg btn-primary">Link Another Account</button>
		<button class="link-btn-no ml-3 btn btn-lg btn-outline-info" value="1">No</button>
	</p>
</div>

<div id="are_you_sure" class="panel-collapse collapse in">
	<div class="card border mb-3">
	  <div class="card-body">
	  	<h4 class="card-title">These are the accounts often linked by other survey participants. Please take a look at this list:</h4>
	    <p class="card-text">
	    	<ul>
			<li>Checking Accounts</li>
			<li>Savings Accounts</li>
			<li>Credit Card Accounts</li>
			<li>Pre-paid Credit Card</li>
			<li>Money Market Accounts</li>
			<li>CD's</li>
			<li>Mortgages</li>
			<li>Home Equity Line of Credit (HELOC)</li>
			<li>Employer-sponsored retirement accounts (401k, 403(b), and similar)</li> 
			<li>Investment Retirement Accounts (IRA)</li>
			<li>Brokerage Accounts</li>
			</ul>
			Think about all the accounts in the financial institutions you have linked. Do you have accounts in other financial institutions you may have forgotten and would like to link?
		</p>
	  </div>
	</div>
	<p>
		<button class="link-btn btn btn-lg btn-primary">Link Another Account</button>
		<button class="link-btn-no ml-3 btn btn-lg btn-outline-info" value="2">No</button>
	</p>
</div>

<div id="final" class="panel-collapse collapse in">
	<div class="card border mb-3">
	  <div class="card-body">
	  	<h4 class="card-title">Thank you for linking your financial institutions!</h4>
	    <p class="card-text">
	    	As a reminder, please be assured that we DO NOT have access to your credentials or any other identifying information.
	    	<br/> 
			Your financial information will be kept secure and protected. Plaid will never share your login IDs, passwords, or any other personal information with UAS researchers or anyone else.
			<br/><br/>
			You will be able to add financial institutions at any time in case you forget some or in case you establish relationships with new ones.
			<br/><br/>
			You will be able to unlink your financial institutions at any time if you wish to do so.
			<br/><br/>
			You can also unlink specific accounts within a financial institution. If you wish to do so, please let us know.
			<br/><br/>
			Now that you have linked your institutions, no further action is required and you will keep earning your monthly rewards. However, we may periodically ask you to refresh the links with your financial institutions if something changes. This will ensure that you will receive your monthly rewards.
		</p>
	  </div>
	</div>
	<p>
		<button class="link-btn-dashboard btn btn-lg btn-outline-info">Go to dashboard</button>
	</p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
  (function($) {
    $.ajaxSetup({ // SWOOP: CSRF Token
  		data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
	});

    var products = '{{ plaid_products }}'.split(',');
    if (products.includes('assets')) {
      $('#assets').show();
    }

    var handler = Plaid.create({
      apiVersion: 'v2',
      clientName: 'UASFin',
      env: '{{ plaid_environment }}',
      product: products,
      key: '{{ plaid_public_key }}',
      webhook: '{{ plaid_webhook_url }}',
      // token: 'public-sandbox-8e318f33-bbad-4b08-9e35-1be41ec10af3',
      onSuccess: function(public_token) {
        $.post('/get_access_token/', {
          public_token: public_token,
        }, function(data) {
          $('#intro').fadeOut('fast', function() {
          	window.console.log('\n\nItemId: ' + data.auth.item_id + '\nAccess Token: ' + data.auth.access_token + '\nRequest Id: ' + data.auth.request_id + '\nInstitution Id: ' + data.item.institution_id + '\nInstitution Name: ' + data.institution.name );
            if (data.duplicate) {
            	$('#failure_summary').html('<strong>' + data.institution.name + '</strong> account was previously linked!! </strong>');
            	$('#failure').show();
            	$('#success').hide();
            	$('#are_you_sure').hide();
            	$('#final').hide();
            } else {
            	$('#success_summary').html('Success! <strong>' + data.institution.name + '</strong> was succesfully linked to UASFin!');	
            	$('#success').show();
            	$('#failure').hide();
            	$('#are_you_sure').hide();
            	$('#final').hide();
            }
          });
        });
      },
    });
    
    $('.link-btn').on('click', function(e) {
		handler.open();
    });
    $('.link-btn-dashboard').on('click', function(e) {
		window.location.href='/';
    });

    $('.link-btn-no').on('click', function(e) {
        if ($(this).val() == 1) {
            $('#intro').hide();
		    $('#success').hide();
		    $('#failure').hide();
		    $('#are_you_sure').show();
		    $('#final').hide();
    	} else {
            $('#intro').hide();
		    $('#success').hide();
		    $('#failure').hide();
		    $('#are_you_sure').hide();
		    $('#final').show();
    	}
    });

    })(jQuery);

function qs(key) {
    key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
    var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
    return match && decodeURIComponent(match[1].replace(/\+/g, " "));
}
</script>
{% endblock content %}
