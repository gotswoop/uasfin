{% extends 'fin/base.html' %}
{% block content %}
{% load humanize %}
<style>
.nounderline {
  text-decoration: none !important
}
</style>
<div id="intro">
	<div class="row">
		<div class="col-md-8">
			<div class="card border bg-light">
				<div class="card-header">
					<div class="float-left">
						&nbsp;
						<br/>
			      		<h5>My Linked Accounts ({{ items|length }})</h5>
		    		</div>
		    		<div class="float-right mt-3 mr-3">
		      			<button class="link-btn btn btn-lg btn-primary">Link Another Account</button>
		    		</div>
				</div>
				<div class="card-body bg-white">
					<h6>Click on institution name for more details:</h6>
			        <table class="table bg-white">
						<tbody>
							{% for item in items %}
							{% with cnt=forloop.counter %}
							<tr>
								<td style="width: 85%"><a class="btn btn-outline-info btn-md btn-block text-left" href="{% url 'account_details' item_id=item.id %}">{{ cnt }}. {{ item.p_item_name }}</a></td>
								<td><span class="text-success">Active</span></td>
							</tr>
							{% endwith %}
							{% endfor %}
						</tbody>
					</table>
				</div>
				<div class="card-footer">
					You have {{ items|length }} financial institution{% ifnotequal items|length 1 %}s{% endifnotequal %} linked. For each additional institution you link, you will earn a reward of $10 right now, plus a reward of $5 every month.
				</div>
			</div>
			<br/><br/>
		</div>
		<div class="col-md-4">
			<div class="card">
				<div class="card-header bg-success text-white">
					<h6>Number of Institutions Linked: {{ items|length }}</h6>
					<h6>Monthly Rewards Earnings: ${% widthratio 5 1 items|length %}</h6></div>
			 </div>
			<div class="card mt-2">
			  <div class="card-body border border-success">
			    <p class="card-text">
			    	These are the accounts often linked by other survey participants. Please take a look at this list:
					<ul>
					<li>Checking Accounts</li>
					<li>Savings Accounts</li>
					<li>Credit Card Accounts</li>
					<li>Pre-paid Credit Card</li>
					<li>Money Market Accounts</li>
					<li>CD's</li>
					<li>Mortgages</li>
					<li>Home Equity Line of Credit (HELOC)</li>
					<li>Employer-sponsored retirement accounts (401k, 403(b), and similar)</li> 
					<li>Investment Retirement Accounts (IRA)</li>
					<li>Brokerage Accounts</li>
					</ul>
					Think about all the accounts you have linked. Do you have accounts in other financial institutions you may have forgotten and would like to link?
				</p>
			  </div>
			</div>
		</div>
	</div>
</div>

<div id="success" class="panel-collapse collapse in">
	<div class="card mb-3">
		<div class="card-body">
	  		<h4 id="success_summary" class="card-title text-success"></h4>
	  		<p class="card-text pt-2">Would you like to link another institution?<br/><br/>For each financial institution you link, you will earn a reward of $10 right now, plus a reward of $5 every month</p>
	  	</div>
	</div>
	<p>
		<button class="link-btn btn btn-lg btn-primary">Link Another Account</button>
		<button class="link-btn-dashboard ml-3 btn btn-lg btn-outline-info">Go to dashboard</button>
	</p>
</div>

<div id="failure" class="panel-collapse collapse in">
	<div class="card mb-3">
		<div class="card-body">
	  		<h4 id="failure_summary" class="card-title text-danger"></h4>
	  		<p class="card-text pt-2">Would you like to link a different institution?<br/><br/>For each financial institution you link, you will earn a reward of $10 right now, plus a reward of $5 every month</p>
	  	</div>
	</div>
	<p>
		<button class="link-btn btn btn-lg btn-primary">Link Another Account</button>
		<button class="link-btn-dashboard ml-3 btn btn-lg btn-outline-info">Go to dashboard</button>
	</p>
</div>
	
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
<script>
  (function($) {
    $.ajaxSetup({ // SWOOP: CSRF Token
  		data: {csrfmiddlewaretoken: '{{ csrf_token }}' },
	});

    $(document)
  		.ajaxStart(function () {
    		$('.container').hide();
  		})
  		.ajaxStop(function () {
			$('.container').show();
  		});

    var products = '{{ plaid_products }}'.split(',');
    if (products.includes('assets')) {
      $('#assets').show();
    }

    var handler = Plaid.create({
      apiVersion: 'v2',
      clientName: 'UASFin',
      env: '{{ plaid_environment }}',
      product: products,
      key: '{{ plaid_public_key }}',
      webhook: '{{ plaid_webhook_url }}',
      // token: 'public-sandbox-8e318f33-bbad-4b08-9e35-1be41ec10af3',
      onSuccess: function(public_token) {
        $.post('/get_access_token/', {
          public_token: public_token,
        }, function(data) {
          $('#intro').fadeOut('fast', function() {
          	window.console.log('\n\nItemId: ' + data.auth.item_id + '\nAccess Token: ' + data.auth.access_token + '\nRequest Id: ' + data.auth.request_id + '\nInstitution Id: ' + data.item.institution_id + '\nInstitution Name: ' + data.institution.name );
            if (data.duplicate) {
            	$('#failure_summary').html('<strong>' + data.institution.name + '</strong> account was previously linked!! </strong>');
            	$('#failure').show();
            	$('#success').hide();
            } else {
                $('#success_summary').html('<strong>' + data.institution.name + '</strong> was successfully linked to UASFin!');
            	$('#success').show();
            	$('#failure').hide();
            }
          });
        });
      },
    });
    
    $('.link-btn').on('click', function(e) {
		handler.open();
    });

    $('.link-btn-dashboard').on('click', function(e) {
		window.location.href='/';
    });

     })(jQuery);

function qs(key) {
    key = key.replace(/[*+?^$.\[\]{}()|\\\/]/g, "\\$&"); // escape RegEx meta chars
    var match = location.search.match(new RegExp("[?&]"+key+"=([^&]+)(&|$)"));
    return match && decodeURIComponent(match[1].replace(/\+/g, " "));
}
</script>
{% endblock content %}
